!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Revuex=t()}(this,function(){"use strict";var h=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),n=function(){function c(e,t,r){if(h(this,c),this.store=r,!Array.isArray(e))throw new Error("[revuex] Expect module path to be an array.");var o,n;if(0===e.length?(this.isRoot=!0,this.name="@@root",this.path="@@root"):(this.isRoot=!1,this.name=e[e.length-1],1===e.length?this.path=e[0]:this.path=e.join("/")),r.modulesMap[this.path]=this,0===e.length)n=null;else if(1===e.length)n=r.modulesMap["@@root"];else{var i=e.slice();i.pop(),o=i.join("/"),n=r.modulesMap[o]}if((this.parent=n)&&(n.modules[this.name]=this),this.modules={},t.modules)for(var u in t.modules){var a=e.slice();a.push(u),this.modules[u]=new c(a,t.modules[u],r)}for(var s in this.initialState=t.state||{},this.indexState,this.childrenState,this.initReducer(t),this.creators=t.creators||{},this.creators)this.isRoot?Object.assign(r._creatorsMap,this.creators):r._creatorsMap[this.path+"/"+s]=this.creators[s];this.handlers=t.actions||{}}return e(c,[{key:"initReducer",value:function(e){this.updateReducer()}},{key:"updateReducer",value:function(){var c=this;if(c.indexReducer=function(e,t){return c.handlers[t.type]?c.handlers[t.type](e,t):e},0<(Object.keys(c.modules)||[]).length){var e={};for(var t in this.modules)e[t]=this.modules[t].reducer;c.childrenReducer=c.store.redux.combineReducers(e)}else c.childrenReducer=function(e,t){return e};c.reducer=function(e,t){if(c.isRoot&&console.log("\nReducing: "+t.type),void 0===e&&(e=c.initialState),t.type){var r,o;if(e){if("[object Object]"!==e.toString())throw new Error("[revuex] State of a module must be a plain object!");for(var n in r={},o={},e)c.modules[n]?o[n]=e[n]:r[n]=e[n]}var i=t.type,u=t.type.split("/"),a=u.pop(),s=u.join("/")||"@@root";return o=(s===c.path?(console.log("[revuex] path '"+s+"' matched action: "+t.type),t.type=a,r=c.indexReducer(r,t),t.type=i):r=c.indexReducer(r,t),c.childrenReducer(o,t)),c.mergeState(r,o)}throw new Error("[revuex] Action needs a type field.")}}},{key:"mergeState",value:function(e,t){var r={};for(var o in e){if(this.modules[o])throw new Error('[revuex] Duplicated state key "'+o+'" in module "'+this.path+"\".'");r[o]=e[o]}for(var n in t)r[n]=t[n];return r}}]),c}(),t=function(){function t(e){if(h(this,t),!e.redux)throw new Error("[revuex] 'Redux' must be assigned to options.redux");this.redux=e.redux,this.modulesMap={},this._creatorsMap={},this._rootModule=new n([],e,this),this._reduxStore=this.redux.createStore(this._rootModule.reducer,void 0),this.getState=this._reduxStore.getState,this.subscribe=this._reduxStore.subscribe}return e(t,[{key:"invoke",value:function(e,t){var n=this;if(console.log("[revuex] Invoking action creator: "+e),!this._creatorsMap[e])throw new Error("[revuex] Unknown action creator: "+e+".");var r=e.split("/");r.pop();var i=r.join("/"),o={invoke:function(e,t,r){return r&&r.root?n.invoke(e,t):n.invoke(i+"/"+e,t)},dispatch:function(e,t,r){var o=t||{};return r&&r.root?o.type=e:o.type=(""===i?"":i+"/")+e,n._reduxStore.dispatch(o)}};return Object.defineProperty(o,"rootState",{enumerable:!0,configurable:!0,get:function(){return n._reduxStore.getState()},set:function(){throw new Error("[revuex] The state must not be mutated.")}}),Object.defineProperty(o,"state",{enumerable:!0,configurable:!0,get:function(){var t=n._reduxStore.getState();return r.forEach(function(e){t=t[e]}),t},set:function(){throw new Error("[revuex] The state must not be mutated.")}}),n._creatorsMap[e](o,t)}},{key:"dispatch",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};t.type=e,this._reduxStore.dispatch(t)}},{key:"ensure",value:function(e,t){this.registerModule(e,t)}},{key:"registerModule",value:function(e,t){if(!Array.isArray(e))throw new Error("[revuex] Expect pathArr to be an array but get "+e.toString());var r=e.join("/");if(!this.modulesMap[r]){console.log("[revuex] Registering module "+r);for(var o=new n(e,t,this);o.parent;)o.parent.updateReducer(),o=o.parent}}}]),t}();return{use:function(e){},createStore:function(e){return new t(e)}}});
